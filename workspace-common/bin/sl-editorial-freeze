#!/bin/bash
#small script for messaging a slack channel
#https://api.slack.com/methods/chat.postMessage

#GITHUB_PROJECT=(project on github.com)
#SLACK_TOKEN=(get token from https://api.slack.com/authentication/token-types#user)
#GITHUB_TOKEN=(get token from https://github.com/settings/tokens)

SLACK_CHANNELS="C0317UN5K8D,C05FZ5NB8J1"
SLACK_CHANNELS_DEBUG="C062R58KY9K"

WORKSPACE_PROJECT_NAME="televisa"
REPOS="client-cms-web,service-editorial,service-editorial-cloud-functions,service-editorial-scheduler,service-editorial-dependencies-update"
BRANCH="main"

MESSAGE=""
MERGE_FREE=":free:"
MERGE_LOCKED=":lock:"

echo "Loading message..."

## find out which repos have branch protection
for REPO in ${REPOS//,/ }
do
    curl -sL \
    -H "Accept: application/vnd.github+json" \
    -H "Authorization: Bearer $GITHUB_TOKEN" \
    -H "X-GitHub-Api-Version: 2022-11-28" \
    "https://api.github.com/repos/$GITHUB_PROJECT/$REPO/branches/$BRANCH/protection" | grep lock_branch -A 2 > .tmp_git_$REPO.json

    MESSAGE="$MESSAGE{\"type\": \"mrkdwn\",\"text\": \"$REPO $(if grep -q false ".tmp_git_$REPO.json"; then echo $MERGE_FREE; else echo $MERGE_LOCKED; fi) \"},"
done

echo "Message to show"
MESSAGE="[{ \"type\": \"header\", \"text\": { \"type\": \"plain_text\", \"text\": \"Main branch protection\"}},{\"type\": \"section\",\"fields\": [$MESSAGE]}]"
echo "$MESSAGE"

echo ""
read -p "Send message to channels? [yes|y|debug|d]" doit
if [[ "$doit" == "debug" ]] || [[ $doit == "d" ]]; then
    SLACK_CHANNELS=$SLACK_CHANNELS_DEBUG
fi
case $doit in
    yes|y|d|debug)
        for SLACK_CHANNEL_ID in ${SLACK_CHANNELS//,/ }
        do
            TS=$(curl -sL \
            -X POST \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $SLACK_TOKEN" \
            https://slack.com/api/chat.postMessage \
            -d "channel=$SLACK_CHANNEL_ID&blocks=$MESSAGE" | json_pp | grep -m 1 '"ts" : "' | tr '"' ' ' | tr ',' ' '  | awk '{print $3}')

            curl -sL \
            -X POST \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $SLACK_TOKEN" \
            https://slack.com/api/pins.add \
            -d "channel=$SLACK_CHANNEL_ID&timestamp=$TS"
        done
    ;;
    *) echo "Aborted" ;;
esac

rm .tmp_git_*.json